<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey Explorer | Shuba Yatra</title>
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/navbar.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        #map { 
            height: 500px; 
            width: 100%;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            z-index: 1;
        }

        .map-section {
            padding: var(--space-xl) 0;
            position: relative;
        }

        .weather-panel {
            position: absolute;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            width: 300px;
            padding: 1.5rem;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .weather-item {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
        }

        .weather-item span {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .weather-item b {
            font-size: 1rem;
        }

        .feedback-section {
            padding: var(--space-xl) 0;
        }

        .feedback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }

        .feedback-card {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .feedback-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }

        .feedback-content {
            padding: 1.5rem;
        }

        .nearby-section {
            padding: var(--space-xl) 0;
            background: #f8fafc;
            border-radius: 4rem;
        }

        @media (max-width: 768px) {
            .weather-panel {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin-top: 2rem;
            }
        }
    </style>
</head>
<body>
    <%- include('./components/navbar') %>

    <main class="container">
        <section class="map-section">
            <div id="map"></div>
            
            <div class="glass-dark weather-panel" style="border-radius: var(--radius-lg); color: var(--white);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-size: 1.25rem;">Live Forecast</h3>
                    <span id="temp" style="font-size: 1.5rem; font-weight: 800;">--¬∞C</span>
                </div>
                <p id="weather-location" style="opacity: 0.8; font-size: 0.9rem; margin-bottom: 1rem;">üìç <%- location.to %></p>
                
                <div class="weather-grid">
                    <div class="weather-item">
                        <span>Feels Like</span>
                        <b id="feelsLike">--</b>
                    </div>
                    <div class="weather-item">
                        <span>Humidity</span>
                        <b id="humidity">--</b>
                    </div>
                    <div class="weather-item">
                        <span>High / Low</span>
                        <b id="tempRange">--</b>
                    </div>
                    <div class="weather-item">
                        <span>Pressure</span>
                        <b id="pressure">--</b>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" data-bs-toggle="modal" data-bs-target="#feedbackModal">Share Your Moment</button>
            </div>
        </section>

        <!-- Dynamic Inputs (Hidden) -->
        <input type="hidden" id="fromLat" value="<%- data.fromData[1] %>">
        <input type="hidden" id="fromLng" value="<%- data.fromData[0] %>">
        <input type="hidden" id="toLat" value="<%- data.toData[1] %>">
        <input type="hidden" id="toLng" value="<%- data.toData[0] %>">
        <input type="hidden" id="targetCity" value="<%- location.to %>">

        <section class="feedback-section">
            <div class="section-title" style="margin-bottom: 3rem;">
                <span class="feature-badge">Community Feed</span>
                <h2 style="font-size: 2.5rem; margin-top: 0.5rem;">Memories from <%- location.to %></h2>
            </div>

            <div class="feedback-grid">
                <% if(feedbacks && feedbacks.length > 0) { %>
                    <% feedbacks.forEach((fb) => { %>
                        <div class="card-premium feedback-card">
                            <img src="<%- fb.imageUrl %>" class="feedback-img" alt="Feedback">
                            <div class="feedback-content">
                                <p style="font-style: italic; color: var(--text-primary); margin-bottom: 1rem;">"<%- fb.message %>"</p>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700;">
                                        <%- fb.user.username[0].toUpperCase() %>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 0.9rem;"><%- fb.user.username %></div>
                                        <small style="color: var(--text-muted);"><%- fb.user.email %></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div style="grid-column: 1/-1; padding: 5rem; text-align: center; border: 2px dashed #e2e8f0; border-radius: var(--radius-lg);">
                        <p style="color: var(--text-muted); font-size: 1.1rem;">No shared moments yet. Be the first to share one!</p>
                    </div>
                <% } %>
            </div>
        </section>

        <section class="nearby-section">
            <div class="container">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4rem;">
                    <div>
                        <h3 style="margin-bottom: 2rem; font-size: 1.75rem;">Nearby Adventures</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <% trips?.forEach((trip) => { %>
                                <div class="card-premium" style="display: flex; gap: 1rem; padding: 1rem; cursor: pointer;" onclick="window.location.href='/trip/<%-trip.id%>'">
                                    <img src="<%- trip.tripImages[0].imageUrl %>" style="width: 80px; height: 80px; border-radius: var(--radius-md); object-fit: cover;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 1rem;"><%- trip.name %></h4>
                                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;"><%- trip.famousFor %></p>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 2rem; font-size: 1.75rem;">Recommended Stays</h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <% hotels?.forEach((hotel) => { %>
                                <div class="card-premium" style="display: flex; gap: 1rem; padding: 1rem; cursor: pointer;" onclick="window.location.href='/hotel/<%-hotel.id%>'">
                                    <img src="<%- hotel.hotelImages[0].imageUrl %>" style="width: 80px; height: 80px; border-radius: var(--radius-md); object-fit: cover;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 1rem;"><%- hotel.hotelName || hotel.hotel %></h4>
                                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;"><%- hotel.hotelAddress %></p>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: var(--radius-lg); border: none;">
                <div class="modal-header" style="background: var(--text-primary); color: var(--white);">
                    <h5 class="modal-title">Share Your Journey</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="/locationreview" method="post" enctype="multipart/form-data">
                    <div class="modal-body p-4">
                        <input type="hidden" name="location" value="<%- location %>">
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Story & Insights</label>
                            <textarea name="message" class="form-control" rows="4" placeholder="What made this place special?" required style="border-radius: var(--radius-md);"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Post a Photo</label>
                            <input type="file" name="image" class="form-control" required style="border-radius: var(--radius-md);">
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="submit" class="btn btn-primary w-100 py-3">Publish Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('./components/footer') %>

    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const fromLat = document.getElementById('fromLat').value;
        const fromLng = document.getElementById('fromLng').value;
        const toLat = document.getElementById('toLat').value;
        const toLng = document.getElementById('toLng').value;
        const city = document.getElementById('targetCity').value;

        // Weather Integration
        fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city},np&APPID=b34aabf484ce3d26a8f521ac013f3ca7`)
            .then(res => res.json())
            .then(data => {
                const feelsLike = (data.main.feels_like - 273.15).toFixed(1);
                const temp = (data.main.temp - 273.15).toFixed(1);
                const tMax = (data.main.temp_max - 273.15).toFixed(1);
                const tMin = (data.main.temp_min - 273.15).toFixed(1);

                document.getElementById('temp').textContent = `${temp}¬∞C`;
                document.getElementById('feelsLike').textContent = `${feelsLike}¬∞C`;
                document.getElementById('humidity').textContent = `${data.main.humidity}%`;
                document.getElementById('tempRange').textContent = `${tMax}¬∞ / ${tMin}¬∞`;
                document.getElementById('pressure').textContent = `${data.main.pressure} hPa`;
            })
            .catch(err => console.error('Weather Fetch Error:', err));

        // Map Integration
        const map = L.map('map').setView([fromLat, fromLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        L.Routing.control({
            waypoints: [
                L.latLng(fromLat, fromLng),
                L.latLng(toLat, toLng)
            ],
            routeWhileDragging: false,
            show: false, // Hide textual instructions for a cleaner map
            createMarker: function(i, wp, n) {
                return L.marker(wp.latLng, {
                    draggable: false,
                    title: i === 0 ? "Start" : "Destination"
                });
            }
        }).addTo(map);
    </script>
</body>
</html>
